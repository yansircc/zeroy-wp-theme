name: Build and Release Theme

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even without tag'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y rsync zip
        
    - name: Get theme version
      id: theme_version
      run: |
        VERSION=$(grep "Version:" style.css | head -1 | sed 's/.*Version: *//' | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Theme version: $VERSION"
        
    - name: Create theme package
      run: |
        echo "ğŸš€ Building theme package..."
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p /tmp/zeroy-build
        
        # å¤åˆ¶ä¸»é¢˜æ–‡ä»¶ï¼Œæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        rsync -av --exclude='.git' \
                  --exclude='.github' \
                  --exclude='node_modules' \
                  --exclude='dist' \
                  --exclude='.gitignore' \
                  --exclude='.gitattributes' \
                  --exclude='package.json' \
                  --exclude='package-lock.json' \
                  --exclude='README.md' \
                  --exclude='build-and-upload.sh' \
                  --exclude='.env' \
                  --exclude='.claude' \
                  --exclude='.wrangler' \
                  --exclude='*.zip' \
                  . /tmp/zeroy-build/zeroy/
        
        # åˆ›å»º ZIP æ–‡ä»¶
        cd /tmp/zeroy-build
        zip -r "$GITHUB_WORKSPACE/zeroy-${{ steps.theme_version.outputs.version }}.zip" zeroy/
        cd $GITHUB_WORKSPACE
        
        # éªŒè¯ ZIP æ–‡ä»¶
        echo "ğŸ“¦ Created package:"
        ls -la "zeroy-${{ steps.theme_version.outputs.version }}.zip"
        
        # æµ‹è¯• ZIP æ–‡ä»¶å†…å®¹
        echo "ğŸ“‹ Package contents:"
        unzip -l "zeroy-${{ steps.theme_version.outputs.version }}.zip" | head -20
        
    - name: Upload to API
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event.inputs.force_release == 'true'
      run: |
        echo "â˜ï¸ Uploading to API..."
        
        # é€šè¿‡ API ä¸Šä¼ 
        RESPONSE=$(curl -X POST \
          -F "file=@zeroy-${{ steps.theme_version.outputs.version }}.zip" \
          -F "theme=zeroy" \
          -F "version=${{ steps.theme_version.outputs.version }}" \
          "https://zeroy.yansir.workers.dev/api/wp-updates/themes/upload" \
          -w "\n%{http_code}" \
          -s)
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | head -n-1)
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Upload successful!"
          echo "$BODY" | jq '.' 2>/dev/null || echo "$BODY"
        else
          echo "âŒ Upload failed (HTTP $HTTP_CODE)"
          echo "$BODY"
          exit 1
        fi
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: Zeroy Theme v${{ steps.theme_version.outputs.version }}
        body: |
          ## Zeroy Theme v${{ steps.theme_version.outputs.version }}
          
          ### ğŸ“¥ ä¸‹è½½
          - [zeroy-${{ steps.theme_version.outputs.version }}.zip](https://zeroy.yansir.workers.dev/api/wp-updates/themes/download/zeroy)
          
          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°
          å¦‚æœæ‚¨çš„ä¸»é¢˜å·²å®‰è£…è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼ŒWordPress åå°ä¼šè‡ªåŠ¨æç¤ºæ›´æ–°ã€‚
          
          ### ğŸ“¦ æ‰‹åŠ¨å®‰è£…
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. åœ¨ WordPress åå°ä¸Šä¼ ä¸»é¢˜
          3. æ¿€æ´»ä¸»é¢˜
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ steps.theme_version.outputs.version }}
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æäº¤: ${{ github.sha }}
          
          ---
          ğŸš€ è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒäº ${{ github.run_started_at }}
        files: |
          zeroy-${{ steps.theme_version.outputs.version }}.zip
        draft: false
        prerelease: false
        
    - name: Notify API server
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "ğŸ”” Notifying API server..."
        
        # å‘é€é€šçŸ¥åˆ° API æœåŠ¡å™¨ (å¯é€‰)
        curl -X POST "https://zeroy.yansir.workers.dev/api/wp-updates/cache/clear" \
          -H "Content-Type: application/json" \
          -d '{"theme": "zeroy", "version": "${{ steps.theme_version.outputs.version }}"}' \
          || echo "âš ï¸ API notification failed or not configured"
        
        echo "âœ… Build and release process completed!"