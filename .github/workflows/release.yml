name: Build and Release Theme

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even without tag'
        required: false
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Get theme version
      id: theme_version
      run: |
        VERSION=$(grep "Version:" style.css | head -1 | sed 's/.*Version: *//' | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Theme version: $VERSION"
        
    - name: Create theme package
      run: |
        echo "ğŸš€ Building theme package..."
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        mkdir -p dist
        
        # å¤åˆ¶ä¸»é¢˜æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        cp -r . dist/zeroy
        
        # ç§»é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        cd dist/zeroy
        rm -rf .git
        rm -rf .github
        rm -rf node_modules
        rm -rf dist
        rm -f .gitignore
        rm -f .gitattributes
        rm -f package.json
        rm -f package-lock.json
        rm -f README.md
        rm -f build-and-upload.sh
        cd ../..
        
        # åˆ›å»º ZIP æ–‡ä»¶
        cd dist
        zip -r "../zeroy-${{ steps.theme_version.outputs.version }}.zip" zeroy/
        cd ..
        
        # éªŒè¯ ZIP æ–‡ä»¶
        echo "ğŸ“¦ Created package:"
        ls -la "zeroy-${{ steps.theme_version.outputs.version }}.zip"
        
        # æµ‹è¯• ZIP æ–‡ä»¶å†…å®¹
        echo "ğŸ“‹ Package contents:"
        unzip -l "zeroy-${{ steps.theme_version.outputs.version }}.zip" | head -20
        
    - name: Upload to R2
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event.inputs.force_release == 'true'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      run: |
        echo "â˜ï¸ Uploading to Cloudflare R2..."
        
        # å®‰è£… wrangler
        npm install -g wrangler
        
        # éªŒè¯ wrangler é…ç½®
        wrangler whoami
        
        # ä¸Šä¼ åˆ° R2
        echo "ğŸ“¤ Uploading versioned file..."
        wrangler r2 object put "zeroy/zeroy-${{ steps.theme_version.outputs.version }}.zip" \
          --file "zeroy-${{ steps.theme_version.outputs.version }}.zip" \
          --content-type "application/zip"
        
        # ä¸Šä¼  latest ç‰ˆæœ¬
        echo "ğŸ“¤ Uploading latest version..."
        wrangler r2 object put "zeroy/zeroy-latest.zip" \
          --file "zeroy-${{ steps.theme_version.outputs.version }}.zip" \
          --content-type "application/zip"
        
        echo "âœ… Upload to R2 completed successfully!"
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        name: Zeroy Theme v${{ steps.theme_version.outputs.version }}
        body: |
          ## Zeroy Theme v${{ steps.theme_version.outputs.version }}
          
          ### ğŸ“¥ ä¸‹è½½
          - [zeroy-${{ steps.theme_version.outputs.version }}.zip](https://zeroy.yansir.workers.dev/api/theme-updates/download/zeroy)
          
          ### ğŸ”„ è‡ªåŠ¨æ›´æ–°
          å¦‚æœæ‚¨çš„ä¸»é¢˜å·²å®‰è£…è‡ªåŠ¨æ›´æ–°åŠŸèƒ½ï¼ŒWordPress åå°ä¼šè‡ªåŠ¨æç¤ºæ›´æ–°ã€‚
          
          ### ğŸ“¦ æ‰‹åŠ¨å®‰è£…
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. åœ¨ WordPress åå°ä¸Šä¼ ä¸»é¢˜
          3. æ¿€æ´»ä¸»é¢˜
          
          ### ğŸ”§ æŠ€æœ¯ä¿¡æ¯
          - ç‰ˆæœ¬: ${{ steps.theme_version.outputs.version }}
          - æ„å»ºæ—¶é—´: ${{ github.run_number }}
          - æäº¤: ${{ github.sha }}
          
          ---
          ğŸš€ è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒäº ${{ github.run_started_at }}
        files: |
          zeroy-${{ steps.theme_version.outputs.version }}.zip
        draft: false
        prerelease: false
        
    - name: Notify API server
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
      run: |
        echo "ğŸ”” Notifying API server..."
        
        # å‘é€é€šçŸ¥åˆ° API æœåŠ¡å™¨ (å¯é€‰)
        curl -X POST "https://zeroy.yansir.workers.dev/api/theme-updates/cache/clear" \
          -H "Content-Type: application/json" \
          -d '{"theme": "zeroy", "version": "${{ steps.theme_version.outputs.version }}"}' \
          || echo "âš ï¸ API notification failed or not configured"
        
        echo "âœ… Build and release process completed!"